<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Linear Hydrostatic Mountain · ClimateMachine</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../"><img src="../../../assets/logo.svg" alt="ClimateMachine logo"/></a><div class="docs-package-name"><span class="docs-autofit">ClimateMachine</span></div><form class="docs-search" action="../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Getting started</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../GettingStarted/Installation/">Installation</a></li><li><a class="tocitem" href="../../../GettingStarted/RunningClimateMachine/">Running</a></li><li><input class="collapse-toggle" id="menuitem-2-3" type="checkbox"/><label class="tocitem" for="menuitem-2-3"><span class="docs-label">Defaults</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../GettingStarted/Atmos/">Atmosphere model configurations</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-1" type="checkbox" checked/><label class="tocitem" for="menuitem-3-1"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../dry_rayleigh_benard/">Dry Rayleigh Bernard</a></li><li><a class="tocitem" href="../heldsuarez/">Dry Idealized GCM</a></li><li><a class="tocitem" href="../risingbubble/">Rising Thermal Bubble</a></li><li class="is-active"><a class="tocitem" href>Linear Hydrostatic Mountain</a><ul class="internal"><li><a class="tocitem" href="#Description-of-experiment-1"><span>Description of experiment</span></a></li><li><a class="tocitem" href="#Boilerplate-(Using-Modules)-1"><span>Boilerplate (Using Modules)</span></a></li><li><a class="tocitem" href="#init-1"><span>Initial Conditions</span></a></li><li><a class="tocitem" href="#config-helper-1"><span>Model Configuration</span></a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-1-5" type="checkbox"/><label class="tocitem" for="menuitem-3-1-5"><span class="docs-label">Microphysics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Microphysics/ex_1_saturation_adjustment/">Saturation adjustment</a></li><li><a class="tocitem" href="../../Microphysics/ex_2_Kessler/">Kessler</a></li></ul></li></ul></li><li><span class="tocitem">Ocean</span></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Land</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-3-1"><span class="docs-label">Heat</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Land/Heat/heat_equation/">Heat Equation</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-4-1" type="checkbox"/><label class="tocitem" for="menuitem-3-4-1"><span class="docs-label">System Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Numerics/SystemSolvers/cg/">Conjugate Gradient</a></li><li><a class="tocitem" href="../../Numerics/SystemSolvers/bgmres/">Batched Generalized Minimal Residual</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4-2" type="checkbox"/><label class="tocitem" for="menuitem-3-4-2"><span class="docs-label">DG Methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../topo/">Topology</a></li><li><a class="tocitem" href="../../Numerics/DGMethods/nonnegative/">Preserving positivity</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-5-1" type="checkbox"/><label class="tocitem" for="menuitem-3-5-1"><span class="docs-label">Debug</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Diagnostics/Debug/StateCheck/">State Statistics Regression</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6" type="checkbox"/><label class="tocitem" for="menuitem-3-6"><span class="docs-label">Contributing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../literate_markdown/">Notes on Literate</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">How-to-guides</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../HowToGuides/Common/Thermodynamics/">Thermodynamics</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../HowToGuides/Atmos/TemperatureProfiles/">TemperatureProfiles</a></li></ul></li><li><span class="tocitem">Ocean</span></li><li><span class="tocitem">Land</span></li><li><input class="collapse-toggle" id="menuitem-4-5" type="checkbox"/><label class="tocitem" for="menuitem-4-5"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><span class="tocitem">Meshes</span></li><li><input class="collapse-toggle" id="menuitem-4-5-2" type="checkbox"/><label class="tocitem" for="menuitem-4-5-2"><span class="docs-label">DG methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../HowToGuides/Numerics/DGMethods/how_to_make_a_balance_law/">How to make a balance law</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-5-3" type="checkbox"/><label class="tocitem" for="menuitem-4-5-3"><span class="docs-label">ODE Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../HowToGuides/Numerics/ODESolvers/Timestepping/">Time-integration</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-5-4" type="checkbox"/><label class="tocitem" for="menuitem-4-5-4"><span class="docs-label">System Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../HowToGuides/Numerics/SystemSolvers/IterativeSolvers/">Iterative Solvers</a></li></ul></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/">Home</a></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../APIs/Atmos/Microphysics/">Microphysics</a></li></ul></li><li><span class="tocitem">Ocean</span></li><li><span class="tocitem">Land</span></li><li><input class="collapse-toggle" id="menuitem-5-5" type="checkbox"/><label class="tocitem" for="menuitem-5-5"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Common/SurfaceFluxes/">Surface Fluxes</a></li></ul></li><li><a class="tocitem" href="../../../APIs/Arrays/Arrays/">Arrays</a></li><li><input class="collapse-toggle" id="menuitem-5-7" type="checkbox"/><label class="tocitem" for="menuitem-5-7"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Diagnostics/Diagnostics/">List of variables</a></li><li><a class="tocitem" href="../../../APIs/Diagnostics/InputOutput/">Input/Output</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-8" type="checkbox"/><label class="tocitem" for="menuitem-5-8"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/Numerics/Meshes/Mesh/">Meshes</a></li><li><a class="tocitem" href="../../../APIs/Numerics/SystemSolvers/SystemSolvers/">SystemSolvers</a></li><li><a class="tocitem" href="../../../APIs/Numerics/ODESolvers/ODESolvers/">ODESolvers</a></li><li><a class="tocitem" href="../../../APIs/Numerics/DGMethods/BalanceLawOverview/">Balance Law</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../Contributing/">Contribution guide</a></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Theory</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-7-1" type="checkbox"/><label class="tocitem" for="menuitem-7-1"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Theory/Common/SurfaceFluxes/">SurfaceFluxes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7-2" type="checkbox"/><label class="tocitem" for="menuitem-7-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Theory/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../Theory/Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../Theory/Atmos/EDMFEquations/">EDMF equations</a></li><li><a class="tocitem" href="../../../Theory/Atmos/Model/turbulence/">Turbulence</a></li><li><a class="tocitem" href="../../../Theory/Atmos/Model/tracers/">Tracers</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox"/><label class="tocitem" for="menuitem-8"><span class="docs-label">Developer docs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../DevDocs/CodeStyle/">Coding style</a></li><li><a class="tocitem" href="../../../DevDocs/AcceptableUnicode/">Acceptable Unicode</a></li><li><a class="tocitem" href="../../../DevDocs/VariableList/">Variable list</a></li><li><a class="tocitem" href="../../../DevDocs/DiagnosticVariables/">Diagnostic variable list</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li><a class="is-disabled">Atmos</a></li><li class="is-active"><a href>Linear Hydrostatic Mountain</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Linear Hydrostatic Mountain</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimateMachine.jl/blob/master/tutorials/Atmos/agnesi_hs_lin.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="EX-LINHS-docs-1"><a class="docs-heading-anchor" href="#EX-LINHS-docs-1">Linear HS mountain waves</a><a class="docs-heading-anchor-permalink" href="#EX-LINHS-docs-1" title="Permalink"></a></h1><p>This test is designed to test the numerical accuracy in preserving discrete hydrostatic balance.</p><h2 id="Description-of-experiment-1"><a class="docs-heading-anchor" href="#Description-of-experiment-1">Description of experiment</a><a class="docs-heading-anchor-permalink" href="#Description-of-experiment-1" title="Permalink"></a></h2><ol><li>Dry Nonlinear Hydrostatic Mountain Waves</li></ol><p>This example of a non-linear hydrostatic mountain wave can be classified as an initial value problem.</p><p>The atmosphere is dry and the flow impinges against a witch of Agnesi mountain of heigh <code>hm=1 m</code> and base parameter <code>a=1,000</code> m and centered in <code>xc = 120 km</code> in a 2D domain <code>\Omega = 240 km\times 30 km</code>. The mountain is defined as</p><p><span>$z = \frac{hm}{1 + \frac{x - xc}{a}}$</span> The 2D problem is setup in 3D by using 1 element in the y direction. To damp the upward moving gravity waves, a Reyleigh absorbing layer is added at <code>z = 15,000 m</code>.</p><p>The initial atmosphere is defined such that it has a stability frequency <code>N=0.02 1/s</code>, where</p><p><span>$N^2 = g\frac{\rm d \ln \theta}{ \rm dz}$</span> so that</p><p><span>$\theta = \theta_0 \exp\left(\frac{N^2 z}{g} \right),$</span> `` \pi = 1 + \frac{g^2}{c<em>p \theta</em>0 N^2}\left(\exp\left(\frac{-N^2 z}{g} \right)\right)</p><p>where <code>theta_0 = 273 K</code>. `` so that</p><p><span>$ρ = \frac{p_{sfc}}{R_{gas}\theta}pi^{c_v/R_{gas}}$</span> and <span>$\theta \pi$</span></p><ol><li>Boundaries<ul><li><code>Impenetrable(FreeSlip())</code> - Top and bottom: no momentum flux, no mass flux through walls.</li><li><code>Impermeable()</code> - non-porous walls, i.e. no diffusive fluxes through  walls.</li><li>Agnesi topography built via meshwarp.</li><li>Laterally periodic</li></ul></li><li>Domain - 500,000 m (horizontal) x 18800 m (horizontal) x 30,000m (vertical) (infinite domain in y)</li><li>Resolution - 2720m X 160 m effective resolution</li><li>Total simulation time - 22.5 hours</li><li>Mesh Aspect Ratio (Effective resolution) 17:1</li><li>Overrides defaults for<ul><li>CPU Initialisation</li><li>Time integrator</li><li>Sources</li></ul></li></ol><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>This experiment setup assumes that you have installed the <code>ClimateMachine</code> according to the instructions on the landing page. We assume the users&#39; familiarity with the conservative form of the equations of motion for a compressible fluid (see the <a href="generated/Atmos/@ref AtmosModel-docs"><code>AtmosModel</code></a> page).</p><p>The following topics are covered in this example</p><ul><li>Package requirements</li><li>Defining a <code>model</code> subtype for the set of conservation equations</li><li>Defining the initial conditions</li><li>Applying source terms</li><li>Choosing a turbulence model</li><li>Adding tracers to the model</li><li>Choosing a time-integrator</li></ul><p>The following topics are not covered in this example</p><ul><li>Defining new boundary conditions</li><li>Defining new turbulence models</li><li>Building new time-integrators</li></ul></div></div><h2 id="Boilerplate-(Using-Modules)-1"><a class="docs-heading-anchor" href="#Boilerplate-(Using-Modules)-1">Boilerplate (Using Modules)</a><a class="docs-heading-anchor-permalink" href="#Boilerplate-(Using-Modules)-1" title="Permalink"></a></h2><h4 id="[Skip-Section](@ref-init)-1"><a class="docs-heading-anchor" href="#[Skip-Section](@ref-init)-1"><a href="generated/Atmos/@ref init">Skip Section</a></a><a class="docs-heading-anchor-permalink" href="#[Skip-Section](@ref-init)-1" title="Permalink"></a></h4><p>Before setting up our experiment, we recognize that we need to import some pre-defined functions from other packages. Julia allows us to use existing modules (variable workspaces), or write our own to do so.  Complete documentation for the Julia module system can be found <a href="https://docs.julialang.org/en/v1/manual/modules/#">here</a>.</p><p>We need to use the <code>ClimateMachine</code> module! This imports all functions specific to atmospheric and ocean flow modelling.  While we do not cover the ins-and-outs of the contents of each of these we provide brief descriptions of the utility of each of the loaded packages.</p><p>The setup of this problem is taken from Case 6 of: @article{giraldoRestelli2008a,   author = {{Giraldo},F.~X. and {Restelli},M.},   title = {A study of spectral element and discontinuous {G}alerkin methods for the {Navier-Stokes} equations in nonhydrostatic mesoscale atmospheric modeling: {E}quation sets and test cases},   journal = {J. Comput. Phys.},   year  = {2008},   volume = {227},   pages  = {3849-3877},</p><pre><code class="language-julia">#},</code></pre><pre><code class="language-julia">using ClimateMachine
ClimateMachine.cli()

using ClimateMachine.Atmos
using ClimateMachine.ConfigTypes
using ClimateMachine.Diagnostics
using ClimateMachine.GenericCallbacks
using ClimateMachine.ODESolvers
using ClimateMachine.Mesh.Filters
using ClimateMachine.Mesh.Topologies
using ClimateMachine.Mesh.Grids
using ClimateMachine.TemperatureProfiles
using ClimateMachine.Thermodynamics
using ClimateMachine.VariableTemplates
using StaticArrays
using Test

using CLIMAParameters
using CLIMAParameters.Atmos.SubgridScale: C_smag
using CLIMAParameters.Planet: R_d, cp_d, cv_d, MSLP, grav
struct EarthParameterSet &lt;: AbstractEarthParameterSet end
const param_set = EarthParameterSet()</code></pre><pre><code class="language-none">Main.ex-agnesi_hs_lin.EarthParameterSet()</code></pre><h2 id="init-1"><a class="docs-heading-anchor" href="#init-1">Initial Conditions</a><a class="docs-heading-anchor-permalink" href="#init-1" title="Permalink"></a></h2><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The following variables are assigned in the initial condition</p><ul><li><code>state.ρ</code> = Scalar quantity for initial density profile</li><li><code>state.ρu</code>= 3-component vector for initial momentum profile</li><li><code>state.ρe</code>= Scalar quantity for initial total-energy profile humidity</li></ul></div></div><pre><code class="language-">function init_agnesi_hs_lin!(bl, state, aux, (x, y, z), t)</code></pre><p>Problem float-type</p><pre><code class="language-">    FT = eltype(state)</code></pre><p>Unpack constant parameters</p><pre><code class="language-">    R_gas::FT = R_d(bl.param_set)
    c_p::FT = cp_d(bl.param_set)
    c_v::FT = cv_d(bl.param_set)
    p0::FT = MSLP(bl.param_set)
    _grav::FT = grav(bl.param_set)
    γ::FT = c_p / c_v

    c::FT = c_v / R_gas
    c2::FT = R_gas / c_p

    Tiso::FT = 250.0
    θ0::FT = Tiso

    Brunt::FT = _grav / sqrt(c_p * Tiso)
    Brunt2::FT = Brunt * Brunt
    g2::FT = _grav * _grav

    π_exner::FT = exp(-_grav * z / (c_p * Tiso))
    θ::FT = θ0 * exp(Brunt2 * z / _grav)
    ρ::FT = p0 / (R_gas * θ) * (π_exner)^c</code></pre><p>Compute perturbed thermodynamic state:</p><pre><code class="language-">    T = θ * π_exner
    e_int = internal_energy(bl.param_set, T)
    ts = PhaseDry(bl.param_set, e_int, ρ)

    #initial velocity
    u = FT(20.0)

    #State (prognostic) variable assignment
    e_kin = FT(0)                                       # kinetic energy
    e_pot = gravitational_potential(bl.orientation, aux)# potential energy
    ρe_tot = ρ * total_energy(e_kin, e_pot, ts)         # total energy

    state.ρ = ρ
    state.ρu = SVector{3, FT}(ρ * u, 0, 0)
    state.ρe = ρe_tot
end

function setmax(f, xmax, ymax, zmax)
    function setmaxima(xin, yin, zin)
        return f(xin, yin, zin; xmax = xmax, ymax = ymax, zmax = zmax)
    end
    return setmaxima
end

function warp_agnesi(xin, yin, zin; xmax = 1000.0, ymax = 1000.0, zmax = 1000.0)

    FT = eltype(xin)

    ac = FT(10000)
    hm = FT(1)
    xc = FT(0.5) * xmax
    zdiff = hm / (FT(1) + ((xin - xc) / ac)^2)</code></pre><p>Linear relaxation towards domain maximum height</p><pre><code class="language-">    x, y, z = xin, yin, zin + zdiff * (zmax - zin) / zmax
    return x, y, z
end</code></pre><h2 id="config-helper-1"><a class="docs-heading-anchor" href="#config-helper-1">Model Configuration</a><a class="docs-heading-anchor-permalink" href="#config-helper-1" title="Permalink"></a></h2><p>We define a configuration function to assist in prescribing the physical model. The purpose of this is to populate the <a href="generated/Atmos/@ref LESConfig"><code>ClimateMachine.AtmosLESConfiguration</code></a> with arguments appropriate to the problem being considered.</p><pre><code class="language-">function config_agnesi_hs_lin(FT, N, resolution, xmax, ymax, zmax)

    u_relaxation = SVector(FT(20), FT(0), FT(0))
    c_sponge = 1
    amp = 1.0</code></pre><p>Rayleigh damping</p><pre><code class="language-">    zsponge = FT(12500.0)
    rayleigh_sponge =
        RayleighSponge{FT}(zmax, zsponge, c_sponge, u_relaxation, 2)

    ##SR LSRK144
    ode_solver = ClimateMachine.ExplicitSolverType(
        solver_method = LSRK144NiegemannDiehlBusch,
    )

    source = (Gravity(), rayleigh_sponge)

    temp_profile_ref = DecayingTemperatureProfile{FT}(param_set)
    ref_state = HydrostaticState(temp_profile_ref)
    nothing # hide

    _C_smag = FT(0.23)
    model = AtmosModel{FT}(
        AtmosLESConfigType,
        param_set;
        turbulence = SmagorinskyLilly(_C_smag),
        moisture = DryModel(),
        source = source,
        tracers = NoTracers(),
        init_state_conservative = init_agnesi_hs_lin!,
        ref_state = ref_state,
    )

    config = ClimateMachine.AtmosLESConfiguration(
        &quot;Agnesi_HS_LINEAR&quot;,      # Problem title [String]
        N,                       # Polynomial order [Int]
        resolution,              # (Δx, Δy, Δz) effective resolution [m]
        xmax,                    # Domain maximum size [m]
        ymax,                    # Domain maximum size [m]
        zmax,                    # Domain maximum size [m]
        param_set,               # Parameter set.
        init_agnesi_hs_lin!,     # Function specifying initial condition
        solver_type = ode_solver,# Time-integrator type
        model = model,           # Model type
        meshwarp = setmax(warp_agnesi, xmax, ymax, zmax),
    )

    return config
end

function main()

    FT = Float64

    N = 4
    Δh = FT(1200)
    Δv = FT(240)
    resolution = (Δh, Δh, Δv)
    xmax = FT(240000)
    ymax = FT(4800)
    zmax = FT(30000)
    t0 = FT(0)
    hrs = FT(1)
    timeend = FT(hrs * 60 * 60)

    Courant = FT(0.25)</code></pre><p>Assign configurations so they can be passed to the <code>invoke!</code> function</p><pre><code class="language-">    driver_config = config_agnesi_hs_lin(FT, N, resolution, xmax, ymax, zmax)
    solver_config = ClimateMachine.SolverConfiguration(
        t0,
        timeend,
        driver_config,
        init_on_cpu = true,
        Courant_number = Courant,
    )</code></pre><p>User defined filter (TMAR positivity preserving filter)</p><pre><code class="language-julia">    cbtmarfilter = GenericCallbacks.EveryXSimulationSteps(1) do (init = false)
        Filters.apply!(solver_config.Q, 6, solver_config.dg.grid, TMARFilter())
        nothing
    end</code></pre><pre><code class="language-none">ClimateMachine.GenericCallbacks.EveryXSimulationSteps([0], 1, Main.ex-agnesi_hs_lin.var&quot;#1#2&quot;())</code></pre><p>Invoke solver (calls <code>solve!</code> function for time-integrator), pass the driver, solver and diagnostic config information.</p><pre><code class="language-">    result = ClimateMachine.invoke!(
        solver_config;
        #user_callbacks = (cbtmarfilter,),
        check_euclidean_distance = true,
    )</code></pre><p>Check that the solution norm is reasonable.</p><pre><code class="language-">    @test isapprox(result, FT(1); atol = 1.5e-3)
end</code></pre><pre><code class="language-">main()</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../risingbubble/">« Rising Thermal Bubble</a><a class="docs-footer-nextpage" href="../../Microphysics/ex_1_saturation_adjustment/">Saturation adjustment »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Thursday 4 June 2020 21:34">Thursday 4 June 2020</span>. Using Julia version 1.3.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
